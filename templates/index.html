{% extends "base.html" %}

{% block title %}MCP Guardrail Patterns for Healthcare AI{% endblock %}

{% block content %}
<div class="r6-hero" style="margin:-1.5rem -12px 2rem;padding:3rem 1.5rem;">
  <div class="text-center" style="position:relative;z-index:1">
    <h1 style="font-size:2.5rem;font-weight:800;margin-bottom:0.5rem">
      <i class="fas fa-shield-alt" style="color:var(--r6-primary)"></i>
      MCP Guardrail Patterns for Healthcare AI
    </h1>
    <p class="lead" style="color:var(--r6-text-muted);max-width:700px;margin:0 auto 1rem">
      How tenant isolation, access control, audit trails, PHI redaction, and human-in-the-loop enforcement
      work together when AI agents access clinical data through Model Context Protocol + FHIR R6.
    </p>
    <div style="max-width:700px;margin:0 auto 1.5rem;display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;">
      <a href="{{ url_for('r6_dashboard') }}" class="r6-btn r6-btn-primary" style="font-size:1rem;padding:0.75rem 2rem">
        <i class="fas fa-bolt"></i> Run the 60-Second Demo
      </a>
      <a href="{{ url_for('r6_dashboard') }}" class="r6-btn r6-btn-outline" style="font-size:1rem;padding:0.75rem 2rem">
        <i class="fas fa-th-large"></i> Explore All Patterns
      </a>
    </div>
    <div style="color:var(--r6-text-muted);font-size:0.8rem;max-width:600px;margin:0 auto;padding:0.75rem;border:1px solid rgba(255,255,255,0.1);border-radius:8px;background:rgba(0,0,0,0.2)">
      <strong>What this is:</strong> A pattern library for developers building MCP + FHIR integrations.
      The FHIR server is scaffolding; the guardrail architecture is the product.
    </div>
  </div>
</div>

<!-- The Story: 6-Step Guardrail Sequence -->
<div class="r6-panel mb-5" style="border-color: var(--r6-primary); box-shadow: 0 0 30px rgba(99, 102, 241, 0.15);">
  <div class="r6-panel-header" style="background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); border-bottom-color: var(--r6-primary);">
    <i class="fas fa-bolt" style="color: #fbbf24; font-size: 1.1rem;"></i>
    <h3 style="color: #fbbf24;">The Story: What Happens When an AI Agent Tries to Write Clinical Data?</h3>
  </div>
  <div class="r6-panel-body">
    <div class="row g-3">
      <div class="col-md-4">
        <div style="padding:0.75rem;border-left:3px solid var(--r6-info);background:rgba(6,182,212,0.05);border-radius:0 0.5rem 0.5rem 0">
          <div style="font-weight:700;font-size:0.85rem;margin-bottom:0.25rem"><span style="color:var(--r6-info)">1.</span> Read Patient Record</div>
          <div style="font-size:0.78rem;color:var(--r6-text-muted)">PHI redacted: identifiers masked, addresses stripped, telecom hidden. Agent only sees safe data.</div>
        </div>
      </div>
      <div class="col-md-4">
        <div style="padding:0.75rem;border-left:3px solid var(--r6-primary);background:rgba(99,102,241,0.05);border-radius:0 0.5rem 0.5rem 0">
          <div style="font-weight:700;font-size:0.85rem;margin-bottom:0.25rem"><span style="color:var(--r6-primary)">2.</span> Propose Observation</div>
          <div style="font-size:0.78rem;color:var(--r6-text-muted)">Agent calls $validate. Structural validation gate ensures the resource is well-formed before anything else.</div>
        </div>
      </div>
      <div class="col-md-4">
        <div style="padding:0.75rem;border-left:3px solid var(--r6-danger);background:rgba(239,68,68,0.05);border-radius:0 0.5rem 0.5rem 0">
          <div style="font-weight:700;font-size:0.85rem;margin-bottom:0.25rem"><span style="color:var(--r6-danger)">3.</span> Permission DENIES</div>
          <div style="font-size:0.78rem;color:var(--r6-text-muted)">R6 Permission $evaluate returns deny with reasoning. No active rules = default deny. Agent explains why.</div>
        </div>
      </div>
      <div class="col-md-4">
        <div style="padding:0.75rem;border-left:3px solid var(--r6-success);background:rgba(16,185,129,0.05);border-radius:0 0.5rem 0.5rem 0">
          <div style="font-weight:700;font-size:0.85rem;margin-bottom:0.25rem"><span style="color:var(--r6-success)">4.</span> Policy Change + Re-evaluate</div>
          <div style="font-size:0.78rem;color:var(--r6-text-muted)">Treatment-purpose permit rule created. Re-evaluation returns permit with reasoning showing which rule matched.</div>
        </div>
      </div>
      <div class="col-md-4">
        <div style="padding:0.75rem;border-left:3px solid var(--r6-warning);background:rgba(245,158,11,0.05);border-radius:0 0.5rem 0.5rem 0">
          <div style="font-weight:700;font-size:0.85rem;margin-bottom:0.25rem"><span style="color:var(--r6-warning)">5.</span> Step-up Auth + Human Gate</div>
          <div style="font-size:0.78rem;color:var(--r6-text-muted)">HMAC-SHA256 token issued (128-bit nonce, 5-min TTL). Clinical write requires X-Human-Confirmed header.</div>
        </div>
      </div>
      <div class="col-md-4">
        <div style="padding:0.75rem;border-left:3px solid var(--r6-success);background:rgba(16,185,129,0.05);border-radius:0 0.5rem 0.5rem 0">
          <div style="font-weight:700;font-size:0.85rem;margin-bottom:0.25rem"><span style="color:var(--r6-success)">6.</span> Commit + Audit Trail</div>
          <div style="font-size:0.78rem;color:var(--r6-text-muted)">Write committed. Every step recorded in immutable, append-only AuditEvent trail. Full accountability.</div>
        </div>
      </div>
    </div>
    <div class="text-center mt-3">
      <a href="{{ url_for('r6_dashboard') }}" class="r6-btn r6-btn-primary" style="padding:0.6rem 1.5rem">
        <i class="fas fa-play"></i> Watch This Live in 60 Seconds
      </a>
    </div>
  </div>
</div>

<div class="row g-4 mb-5">
  <div class="col-md-4">
    <div class="r6-panel" style="height:100%">
      <div class="r6-panel-header">
        <i class="fas fa-shield-alt"></i>
        <h3>Security Patterns</h3>
      </div>
      <div class="r6-panel-body">
        <p style="color:var(--r6-text-muted);font-size:0.85rem">
          <strong>What's real:</strong> Mandatory tenant isolation on every query, HMAC-SHA256 step-up tokens
          for writes, ETag/If-Match concurrency control, OAuth 2.1 with PKCE (S256).
          Append-only audit trail with database-level immutability enforcement.
        </p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="r6-panel" style="height:100%">
      <div class="r6-panel-header">
        <i class="fas fa-robot"></i>
        <h3>10 MCP Tools</h3>
      </div>
      <div class="r6-panel-body">
        <p style="color:var(--r6-text-muted);font-size:0.85rem">
          Read tools add <code>_mcp_summary</code> with reasoning, clinical context, and limitations.
          Write tools use a propose/commit pattern: <code>propose_write</code> validates first,
          <code>commit_write</code> requires step-up auth.
          <code>permission_evaluate</code> returns human-readable reasoning.
        </p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="r6-panel" style="height:100%">
      <div class="r6-panel-header">
        <i class="fas fa-heartbeat"></i>
        <h3>Clinical Safety</h3>
      </div>
      <div class="r6-panel-body">
        <p style="color:var(--r6-text-muted);font-size:0.85rem">
          Human-in-the-loop enforcement: clinical writes return HTTP 428 without explicit confirmation.
          HIPAA Safe Harbor de-identification. Medical disclaimer injection.
          PHI redaction on all read paths — the agent never sees raw patient data.
        </p>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mb-5">
  <div class="col-md-6">
    <div class="r6-panel">
      <div class="r6-panel-header">
        <i class="fas fa-layer-group"></i>
        <h3>Architecture</h3>
      </div>
      <div class="r6-panel-body" style="font-size:0.85rem;color:var(--r6-text-muted)">
        <table style="width:100%">
          <tr><td style="padding:0.3rem 0"><strong>Flask App</strong></td><td>R6 REST facade at <code>/r6/fhir/*</code></td></tr>
          <tr><td style="padding:0.3rem 0"><strong>MCP Server</strong></td><td>Node.js + TypeScript — 10 tools with reasoning</td></tr>
          <tr><td style="padding:0.3rem 0"><strong>Storage</strong></td><td>JSON blobs in SQLite (demo) — not production</td></tr>
          <tr><td style="padding:0.3rem 0"><strong>Validation</strong></td><td>Structural only (required fields + value constraints)</td></tr>
          <tr><td style="padding:0.3rem 0"><strong>FHIR Version</strong></td><td>R6 v6.0.0-ballot3</td></tr>
          <tr><td style="padding:0.3rem 0"><strong>Resources</strong></td><td>16 types (7 base + 9 R6 ballot)</td></tr>
        </table>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="r6-panel">
      <div class="r6-panel-header">
        <i class="fas fa-flask"></i>
        <h3>R6-Specific Resources</h3>
      </div>
      <div class="r6-panel-body" style="font-size:0.85rem;color:var(--r6-text-muted)">
        <table style="width:100%">
          <tr><td style="padding:0.3rem 0"><strong>Permission</strong></td><td>R6 access control with $evaluate + reasoning</td></tr>
          <tr><td style="padding:0.3rem 0"><strong>SubscriptionTopic</strong></td><td>Restructured pub/sub (storage + discovery)</td></tr>
          <tr><td style="padding:0.3rem 0"><strong>DeviceAlert</strong></td><td>ISO/IEEE 11073 device alarms (new in R6)</td></tr>
          <tr><td style="padding:0.3rem 0"><strong>NutritionIntake</strong></td><td>Dietary tracking (new in R6)</td></tr>
          <tr><td style="padding:0.3rem 0"><strong>$stats/$lastn</strong></td><td>Standard FHIR ops (since R4, not R6-specific)</td></tr>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-12">
    <div class="r6-panel">
      <div class="r6-panel-header">
        <i class="fas fa-globe"></i>
        <h3>Discovery Endpoints</h3>
      </div>
      <div class="r6-panel-body">
        <div class="row" style="font-size:0.85rem">
          <div class="col-md-3 mb-2">
            <a href="/r6/fhir/metadata" target="_blank" style="color:var(--r6-info);text-decoration:none">
              <i class="fas fa-external-link-alt me-1"></i> /r6/fhir/metadata
            </a>
            <div style="color:var(--r6-text-muted);font-size:0.75rem">CapabilityStatement</div>
          </div>
          <div class="col-md-3 mb-2">
            <a href="/r6/fhir/health" target="_blank" style="color:var(--r6-info);text-decoration:none">
              <i class="fas fa-external-link-alt me-1"></i> /r6/fhir/health
            </a>
            <div style="color:var(--r6-text-muted);font-size:0.75rem">Liveness/Readiness</div>
          </div>
          <div class="col-md-3 mb-2">
            <a href="/r6/fhir/.well-known/smart-configuration" target="_blank" style="color:var(--r6-info);text-decoration:none">
              <i class="fas fa-external-link-alt me-1"></i> SMART Configuration
            </a>
            <div style="color:var(--r6-text-muted);font-size:0.75rem">SMART-on-FHIR v2</div>
          </div>
          <div class="col-md-3 mb-2">
            <a href="/r6/fhir/docs/privacy-policy" target="_blank" style="color:var(--r6-info);text-decoration:none">
              <i class="fas fa-external-link-alt me-1"></i> Privacy Policy
            </a>
            <div style="color:var(--r6-text-muted);font-size:0.75rem">Compliance & Terms</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
