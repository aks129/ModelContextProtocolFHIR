{% extends "base.html" %}

{% block title %}R6 FHIR Agent Dashboard{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/r6-dashboard.css') }}">
{% endblock %}

{% block content %}
<!-- Hero -->
<div class="r6-hero" style="margin: -1.5rem -12px 1.5rem; padding-left: 1.5rem; padding-right: 1.5rem;">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
    <div>
      <h1><i class="fas fa-fire me-2" style="color:var(--r6-primary)"></i>R6 FHIR Agent Dashboard</h1>
      <p class="lead mb-0">Reference implementation: MCP guardrail patterns for FHIR R6 agent access with security, audit, and compliance</p>
    </div>
    <div class="d-flex gap-2">
      <button class="r6-btn r6-btn-primary" onclick="startWalkthrough()">
        <i class="fas fa-play"></i> Run Full Demo
      </button>
      <button class="r6-btn r6-btn-outline" onclick="loadSystemHealth()">
        <i class="fas fa-sync"></i> Refresh
      </button>
    </div>
  </div>
</div>

<!-- Walkthrough Bar (hidden until activated) -->
<div id="walkthrough-bar" class="r6-walkthrough-bar" style="display:none">
  <i class="fas fa-magic"></i>
  <span class="step-counter">1/6</span>
  <span class="step-text">Loading...</span>
  <button class="r6-btn r6-btn-sm r6-btn-outline" onclick="document.getElementById('walkthrough-bar').style.display='none'; walkthroughIdx=99;" style="border-color:white;color:white">Stop</button>
</div>

<!-- Stat Cards -->
<div class="row g-3 mb-4">
  <div class="col-6 col-md">
    <div class="stat-card">
      <div class="stat-value" id="stat-status"><span class="r6-spinner"></span></div>
      <div class="stat-label">Status</div>
    </div>
  </div>
  <div class="col-6 col-md">
    <div class="stat-card">
      <div class="stat-value" id="stat-version">—</div>
      <div class="stat-label">Version</div>
    </div>
  </div>
  <div class="col-6 col-md">
    <div class="stat-card">
      <div class="stat-value" id="stat-fhir">—</div>
      <div class="stat-label">FHIR Version</div>
    </div>
  </div>
  <div class="col-6 col-md">
    <div class="stat-card">
      <div class="stat-value" id="stat-resources">—</div>
      <div class="stat-label">Resource Types</div>
    </div>
  </div>
  <div class="col-6 col-md">
    <div class="stat-card">
      <div class="stat-value" id="stat-operations">—</div>
      <div class="stat-label">Operations</div>
    </div>
  </div>
  <div class="col-6 col-md">
    <div class="stat-card">
      <div class="stat-value" id="stat-audits">0</div>
      <div class="stat-label">Audit Events</div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Left Column: Interactive Panels -->
  <div class="col-lg-8">

    <!-- Patient Explorer -->
    <div class="r6-panel" id="patient-panel">
      <div class="r6-panel-header">
        <i class="fas fa-user-injured"></i>
        <h3>Patient Explorer</h3>
        <span class="r6-tag r6-tag-read">Read/Write</span>
      </div>
      <div class="r6-panel-body">
        <p style="color:var(--r6-text-muted);font-size:0.85rem;margin-bottom:0.75rem">
          Create a sample patient, read it back with PHI redaction, and search. Identifiers are masked, addresses stripped, telecom redacted.
        </p>
        <div class="d-flex gap-2 flex-wrap mb-3">
          <button class="r6-btn r6-btn-primary r6-btn-sm" id="btn-load-patient" onclick="loadSamplePatient()">
            <i class="fas fa-plus"></i> Create + Read Patient
          </button>
          <button class="r6-btn r6-btn-outline r6-btn-sm" id="btn-search-patients" onclick="searchPatients()">
            <i class="fas fa-search"></i> Search All
          </button>
          <button class="r6-btn r6-btn-outline r6-btn-sm" id="btn-patient-count" onclick="searchPatientCount()">
            <i class="fas fa-hashtag"></i> _summary=count
          </button>
          <span style="font-size:0.78rem;color:var(--r6-text-muted);align-self:center">ETag: <code id="patient-etag">—</code></span>
        </div>
        <div class="r6-json-output" id="patient-result"></div>
      </div>
    </div>

    <!-- Agent Tool Loop -->
    <div class="r6-panel" id="tools-panel">
      <div class="r6-panel-header">
        <i class="fas fa-robot"></i>
        <h3>MCP Agent Tool Loop</h3>
        <span class="r6-tag r6-tag-clinical">MCP</span>
      </div>
      <div class="r6-panel-body">
        <p style="color:var(--r6-text-muted);font-size:0.85rem;margin-bottom:0.75rem">
          Select a tool, provide input, and execute. Read tools require no step-up; write tools require HMAC authorization. All emit AuditEvents.
        </p>
        <div class="row">
          <div class="col-md-4">
            <div id="tool-cards"></div>
          </div>
          <div class="col-md-8">
            <div class="mb-2">
              <label style="font-size:0.78rem;color:var(--r6-text-muted)">Selected: <strong id="selected-tool">—</strong></label>
            </div>
            <textarea class="r6-input" id="tool-input" rows="6" placeholder="Tool input (JSON)...">{}</textarea>
            <div class="d-flex gap-2 mt-2">
              <button class="r6-btn r6-btn-primary r6-btn-sm" id="btn-exec-tool" onclick="executeSelectedTool()">
                <i class="fas fa-play"></i> Execute Tool
              </button>
            </div>
            <div class="r6-json-output mt-3" id="tool-result"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Context Builder -->
    <div class="r6-panel" id="context-panel">
      <div class="r6-panel-header">
        <i class="fas fa-layer-group"></i>
        <h3>Context Envelope Builder</h3>
        <span class="r6-tag r6-tag-read">Bundle</span>
      </div>
      <div class="r6-panel-body">
        <p style="color:var(--r6-text-muted);font-size:0.85rem;margin-bottom:0.75rem">
          Ingest a patient-centric Bundle to build a bounded context envelope (TTL 30 min). The envelope provides a policy-stamped, time-limited view for agent context windows.
        </p>
        <div class="d-flex gap-2 flex-wrap mb-3">
          <button class="r6-btn r6-btn-success r6-btn-sm" id="btn-ingest" onclick="ingestDemoBundle()">
            <i class="fas fa-file-import"></i> Ingest Demo Bundle
          </button>
          <button class="r6-btn r6-btn-outline r6-btn-sm" id="btn-get-context" onclick="retrieveContext()">
            <i class="fas fa-eye"></i> Retrieve Context
          </button>
          <span style="font-size:0.78rem;color:var(--r6-text-muted);align-self:center">Context: <code id="last-context-id">—</code></span>
        </div>
        <div class="r6-json-output" id="context-result"></div>
      </div>
    </div>

    <!-- De-identification -->
    <div class="r6-panel" id="deid-panel">
      <div class="r6-panel-header">
        <i class="fas fa-user-secret"></i>
        <h3>HIPAA Safe Harbor De-identification</h3>
        <span class="r6-tag r6-tag-security">PHI</span>
      </div>
      <div class="r6-panel-body">
        <p style="color:var(--r6-text-muted);font-size:0.85rem;margin-bottom:0.75rem">
          Side-by-side comparison: standard redacted read vs. full Safe Harbor de-identification (45 CFR 164.514(b)). Names, IDs, addresses, dates generalized to year.
        </p>
        <button class="r6-btn r6-btn-danger r6-btn-sm mb-3" id="btn-deidentify" onclick="runDeidentify()">
          <i class="fas fa-mask"></i> De-identify Patient
        </button>
        <div class="deid-compare">
          <div class="deid-side">
            <div class="deid-label deid-label-raw">Standard Redaction</div>
            <div class="r6-json-output" id="deid-raw" style="max-height:300px"></div>
          </div>
          <div class="deid-side">
            <div class="deid-label deid-label-safe">Safe Harbor De-identified</div>
            <div class="r6-json-output" id="deid-safe" style="max-height:300px"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Human-in-the-Loop -->
    <div class="r6-panel" id="hitl-panel">
      <div class="r6-panel-header">
        <i class="fas fa-hand-paper"></i>
        <h3>Human-in-the-Loop Enforcement</h3>
        <span class="r6-tag r6-tag-clinical">Clinical Safety</span>
      </div>
      <div class="r6-panel-body">
        <p style="color:var(--r6-text-muted);font-size:0.85rem;margin-bottom:0.75rem">
          Clinical writes (Observation, Condition, etc.) require <code>X-Human-Confirmed: true</code> header. Without it, the server returns HTTP 428 Precondition Required. This prevents autonomous agent writes to clinical data without human review.
        </p>
        <button class="r6-btn r6-btn-primary r6-btn-sm mb-3" id="btn-hitl-demo" onclick="demoHumanInLoop()">
          <i class="fas fa-vial"></i> Run HITL Demo (2 steps)
        </button>
        <div class="r6-json-output" id="hitl-result"></div>
      </div>
    </div>

    <!-- OAuth 2.1 + PKCE -->
    <div class="r6-panel" id="oauth-panel">
      <div class="r6-panel-header">
        <i class="fas fa-shield-alt"></i>
        <h3>OAuth 2.1 + PKCE Flow</h3>
        <span class="r6-tag r6-tag-security">Security</span>
      </div>
      <div class="r6-panel-body">
        <p style="color:var(--r6-text-muted);font-size:0.85rem;margin-bottom:0.75rem">
          Full OAuth 2.1 flow: Dynamic client registration (RFC 7591), Authorization with PKCE S256, Token exchange, and Revocation (RFC 7009). SMART-on-FHIR v2 compatible.
        </p>
        <button class="r6-btn r6-btn-primary r6-btn-sm mb-3" id="btn-oauth-demo" onclick="demoOAuthFlow()">
          <i class="fas fa-lock"></i> Run OAuth Flow (4 steps)
        </button>
        <div class="r6-json-output" id="oauth-result"></div>
      </div>
    </div>

    <!-- R6 Ballot Resources & Operations -->
    <div class="r6-panel" id="phase2-header" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid var(--r6-primary);">
      <div class="r6-panel-header" style="border-bottom-color: var(--r6-primary);">
        <i class="fas fa-flask" style="color: var(--r6-primary)"></i>
        <h3 style="color: var(--r6-primary)">R6 Ballot Resources &amp; Operations</h3>
        <span class="r6-tag r6-tag-write">BALLOT</span>
      </div>
      <div class="r6-panel-body">
        <p style="color:var(--r6-text-muted);font-size:0.85rem;margin-bottom:0.5rem">
          Resources new or restructured in R6 (v6.0.0-ballot3): <strong>Permission</strong> (access control, separate from Consent),
          <strong>SubscriptionTopic</strong> (restructured pub/sub), <strong>NutritionIntake</strong>, <strong>DeviceAlert</strong>.
          Operations <code>$stats</code> and <code>$lastn</code> are standard FHIR operations (available since R4) demonstrated here with stored data.
        </p>
        <p style="color:var(--r6-text-muted);font-size:0.78rem;margin-bottom:0">
          <strong>Scope:</strong> This is a reference implementation for exploring R6 ballot resources and MCP guardrail patterns &mdash; not a production FHIR server.
          Validation is structural only (required fields + value constraints). Search supports code, status, patient, and _lastUpdated parameters.
        </p>
      </div>
    </div>

    <!-- Phase 2: Permission (R6 Access Control) -->
    <div class="r6-panel" id="permission-panel">
      <div class="r6-panel-header">
        <i class="fas fa-user-shield"></i>
        <h3>R6 Permission — Access Control</h3>
        <span class="r6-tag r6-tag-security">R6 NEW</span>
      </div>
      <div class="r6-panel-body">
        <p style="color:var(--r6-text-muted);font-size:0.85rem;margin-bottom:0.75rem">
          R6 separates <strong>Permission</strong> (machine-readable access rules) from <strong>Consent</strong> (patient agreements).
          Permission encodes attribute-based access control with deny-overrides/permit-overrides combining.
          Create a Permission, then evaluate access decisions via <code>$evaluate</code>.
        </p>
        <div class="d-flex gap-2 flex-wrap mb-3">
          <button class="r6-btn r6-btn-primary r6-btn-sm" id="btn-create-permission" onclick="createDemoPermission()">
            <i class="fas fa-plus"></i> Create Permission
          </button>
          <button class="r6-btn r6-btn-outline r6-btn-sm" id="btn-eval-permission" onclick="evaluatePermission()">
            <i class="fas fa-gavel"></i> $evaluate Access
          </button>
        </div>
        <div class="r6-json-output" id="permission-result"></div>
      </div>
    </div>

    <!-- Phase 2: Observation $stats / $lastn -->
    <div class="r6-panel" id="stats-panel">
      <div class="r6-panel-header">
        <i class="fas fa-chart-bar"></i>
        <h3>Observation $stats &amp; $lastn</h3>
        <span class="r6-tag r6-tag-read">FHIR Std</span>
      </div>
      <div class="r6-panel-body">
        <p style="color:var(--r6-text-muted);font-size:0.85rem;margin-bottom:0.75rem">
          Standard FHIR operations (available since R4): <code>$stats</code> computes min/max/mean/count over stored numeric Observation values,
          <code>$lastn</code> returns the most recent observations per code. Both support patient + code filtering.
          Implementation limited to <code>valueQuantity</code> (numeric observations only).
        </p>
        <div class="d-flex gap-2 flex-wrap mb-3">
          <button class="r6-btn r6-btn-success r6-btn-sm" id="btn-seed-obs" onclick="seedObservations()">
            <i class="fas fa-database"></i> Seed Observations
          </button>
          <button class="r6-btn r6-btn-primary r6-btn-sm" id="btn-run-stats" onclick="runObsStats()">
            <i class="fas fa-chart-bar"></i> $stats
          </button>
          <button class="r6-btn r6-btn-outline r6-btn-sm" id="btn-run-lastn" onclick="runObsLastN()">
            <i class="fas fa-history"></i> $lastn
          </button>
        </div>
        <div class="r6-json-output" id="stats-result"></div>
      </div>
    </div>

    <!-- Phase 2: SubscriptionTopic -->
    <div class="r6-panel" id="subscription-panel">
      <div class="r6-panel-header">
        <i class="fas fa-bell"></i>
        <h3>Topic-Based Subscriptions</h3>
        <span class="r6-tag r6-tag-clinical">R6 Ballot</span>
      </div>
      <div class="r6-panel-body">
        <p style="color:var(--r6-text-muted);font-size:0.85rem;margin-bottom:0.75rem">
          R6 restructures Subscription around <strong>SubscriptionTopic</strong> (introduced in R5, maturing in R6).
          Topics define triggerable events. This demo stores topics and subscriptions but does <strong>not</strong> dispatch notifications &mdash;
          it demonstrates the resource model and discovery pattern only.
        </p>
        <div class="d-flex gap-2 flex-wrap mb-3">
          <button class="r6-btn r6-btn-primary r6-btn-sm" id="btn-create-topic" onclick="createDemoTopic()">
            <i class="fas fa-plus"></i> Create Topic
          </button>
          <button class="r6-btn r6-btn-outline r6-btn-sm" id="btn-list-topics" onclick="listTopics()">
            <i class="fas fa-list"></i> $list Topics
          </button>
          <button class="r6-btn r6-btn-outline r6-btn-sm" id="btn-create-subscription" onclick="createDemoSubscription()">
            <i class="fas fa-bell"></i> Subscribe
          </button>
        </div>
        <div class="r6-json-output" id="subscription-result"></div>
      </div>
    </div>

    <!-- Phase 2: NutritionIntake + DeviceAlert -->
    <div class="r6-panel" id="r6resources-panel">
      <div class="r6-panel-header">
        <i class="fas fa-utensils"></i>
        <h3>R6 New Resources</h3>
        <span class="r6-tag r6-tag-write">R6 Core</span>
      </div>
      <div class="r6-panel-body">
        <p style="color:var(--r6-text-muted);font-size:0.85rem;margin-bottom:0.75rem">
          <strong>NutritionIntake</strong>: Records food/liquid/supplement consumption (hospitals, meal tracking, school districts).
          <strong>DeviceAlert</strong>: Medical device alert/alarm conditions aligned with ISO/IEEE 11073 and IEC 60601-1-8.
        </p>
        <div class="d-flex gap-2 flex-wrap mb-3">
          <button class="r6-btn r6-btn-primary r6-btn-sm" id="btn-create-nutrition" onclick="createNutritionIntake()">
            <i class="fas fa-utensils"></i> Create NutritionIntake
          </button>
          <button class="r6-btn r6-btn-danger r6-btn-sm" id="btn-create-alert" onclick="createDeviceAlert()">
            <i class="fas fa-exclamation-triangle"></i> Create DeviceAlert
          </button>
        </div>
        <div class="r6-json-output" id="r6resources-result"></div>
      </div>
    </div>

    <!-- $validate -->
    <div class="r6-panel" id="validate-panel">
      <div class="r6-panel-header">
        <i class="fas fa-check-circle"></i>
        <h3>Resource Validation ($validate)</h3>
        <span class="r6-tag r6-tag-read">Read-only</span>
      </div>
      <div class="r6-panel-body">
        <p style="color:var(--r6-text-muted);font-size:0.85rem;margin-bottom:0.75rem">
          Validate a FHIR R6 resource against structural rules. Agent proposals must pass validation before commit.
        </p>
        <textarea class="r6-input mb-2" id="validate-input" rows="5">{
  "resourceType": "Observation",
  "status": "final",
  "code": {
    "coding": [{"system": "http://loinc.org", "code": "2339-0"}]
  }
}</textarea>
        <button class="r6-btn r6-btn-primary r6-btn-sm mb-3" id="btn-validate" onclick="validateDemo()">
          <i class="fas fa-check"></i> Validate
        </button>
        <div class="r6-json-output" id="validate-result"></div>
      </div>
    </div>

  </div>

  <!-- Right Column: Audit Feed + Info -->
  <div class="col-lg-4">

    <!-- Live Audit Feed -->
    <div class="r6-panel" style="position:sticky;top:1rem">
      <div class="r6-panel-header">
        <i class="fas fa-stream"></i>
        <h3>Live Audit Feed</h3>
        <span class="r6-tag r6-tag-clinical">Append-Only</span>
      </div>
      <div class="r6-panel-body">
        <div class="d-flex gap-2 mb-3">
          <button class="r6-btn r6-btn-outline r6-btn-sm" onclick="refreshAuditFeed()">
            <i class="fas fa-sync"></i> Refresh
          </button>
          <button class="r6-btn r6-btn-outline r6-btn-sm" id="btn-export-audit" onclick="exportAuditNDJSON()">
            <i class="fas fa-download"></i> Export NDJSON
          </button>
        </div>
        <div class="audit-feed" id="audit-feed">
          <div class="text-muted" style="padding:1rem;font-size:0.85rem">No audit events yet. Interact with the panels to generate events.</div>
        </div>
      </div>
    </div>

    <!-- Security Summary -->
    <div class="r6-panel mt-3">
      <div class="r6-panel-header">
        <i class="fas fa-lock"></i>
        <h3>Security Posture</h3>
      </div>
      <div class="r6-panel-body" style="font-size:0.82rem">
        <div class="d-flex justify-content-between mb-2">
          <span>Tenant Isolation</span>
          <span style="color:var(--r6-success)"><i class="fas fa-check-circle"></i> Enforced</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>HMAC Step-up Tokens</span>
          <span style="color:var(--r6-success)"><i class="fas fa-check-circle"></i> Required</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>PHI Redaction</span>
          <span style="color:var(--r6-success)"><i class="fas fa-check-circle"></i> All Reads</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Human-in-the-Loop</span>
          <span style="color:var(--r6-success)"><i class="fas fa-check-circle"></i> Clinical</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>OAuth 2.1 + PKCE</span>
          <span style="color:var(--r6-success)"><i class="fas fa-check-circle"></i> S256</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Audit Trail</span>
          <span style="color:var(--r6-success)"><i class="fas fa-check-circle"></i> Immutable</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>ETag Concurrency</span>
          <span style="color:var(--r6-success)"><i class="fas fa-check-circle"></i> If-Match</span>
        </div>
        <div class="d-flex justify-content-between">
          <span>Medical Disclaimer</span>
          <span style="color:var(--r6-success)"><i class="fas fa-check-circle"></i> Injected</span>
        </div>
      </div>
    </div>

    <!-- Discovery Links -->
    <div class="r6-panel mt-3">
      <div class="r6-panel-header">
        <i class="fas fa-globe"></i>
        <h3>Discovery Endpoints</h3>
      </div>
      <div class="r6-panel-body" style="font-size:0.82rem">
        <div class="mb-2">
          <a href="/r6/fhir/metadata" target="_blank" class="text-decoration-none" style="color:var(--r6-info)">
            <i class="fas fa-external-link-alt me-1"></i> /metadata (CapabilityStatement)
          </a>
        </div>
        <div class="mb-2">
          <a href="/r6/fhir/.well-known/oauth-authorization-server" target="_blank" class="text-decoration-none" style="color:var(--r6-info)">
            <i class="fas fa-external-link-alt me-1"></i> /.well-known/oauth-authorization-server
          </a>
        </div>
        <div class="mb-2">
          <a href="/r6/fhir/.well-known/smart-configuration" target="_blank" class="text-decoration-none" style="color:var(--r6-info)">
            <i class="fas fa-external-link-alt me-1"></i> /.well-known/smart-configuration
          </a>
        </div>
        <div>
          <a href="/r6/fhir/docs/privacy-policy" target="_blank" class="text-decoration-none" style="color:var(--r6-info)">
            <i class="fas fa-external-link-alt me-1"></i> /docs/privacy-policy
          </a>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/r6-dashboard.js') }}"></script>
{% endblock %}
